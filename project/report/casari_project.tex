\providecommand\classoptions{}
\documentclass[a4paper,10pt,twocolumn,\classoptions]{article}

% Packages.
\usepackage[T1]{fontenc}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage[style=ieee,backend=biber]{biblatex}
\usepackage{booktabs}
\usepackage[tableposition=top,figureposition=bottom,font=footnotesize]{caption}
\usepackage{chemformula}
\usepackage{derivative}
\usepackage{listings}
%\usepackage{mathtools}
%\usepackage{physics}
\input{standalone_packages.tex}
%\usepackage{subcaption}
%\usepackage{subfiles}
%\usepackage{tabularx}
%\usepackage{varioref}
\usepackage[hidelinks]{hyperref} % Load last.

% Packages settings.
\addbibresource{bibliography.bib}
%\DeclareGraphicsExtensions{.pdf,.jpg,.png}
\graphicspath{{./figures/}}

% Customization.
\definecolor{Blue}{rgb}{0.2,0.2,0.9}
\definecolor{Green}{rgb}{0,0.6,0}
\definecolor{Gray}{rgb}{0.5,0.5,0.5}
\definecolor{Purple}{rgb}{0.58,0,0.82}
\definecolor{background}{rgb}{0.98,0.98,0.95}
\lstdefinestyle{mystyle}{
  backgroundcolor=\color{background},
  commentstyle=\color{Green},
  keywordstyle=\color{Blue},
  numberstyle=\tiny\color{Gray},
  stringstyle=\color{Purple},
  basicstyle=\ttfamily\footnotesize,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  keepspaces=true,
  numbers=left,
  numbersep=5pt,
  showspaces=false,
  showstringspaces=false,
  showtabs=false,
  tabsize=2
}
\lstdefinestyle{verbatim}{
  basicstyle=\ttfamily,
  columns=fullflexible,
  keepspaces=true,
  numbers=none
}

\newcommand{\cpp}{C++}
\newcommand{\zTOA}{z_\text{TOA}}
\newcommand{\PTOA}{P_\text{TOA}}
\newcommand{\deltaTOA}{\delta_\text{TOA}}

\raggedbottom

% Document.
\begin{document}
\title{Radiative-convective equilibrium in a grey atmosphere}
\author{Marco Casari}
\date{\today}
\maketitle

\begin{abstract}
  Radiative-convective models provide an intermediate complexity approach to the simulation of climate. These models evaluate the atmospheric temperature profile averaged over all latitudes and longitudes, which is function of time and altitude.
  Physical processes which determine the energy exchange in the model are absorption, transmission, reflection of electromagnetic radiation and convection of fluid.
  In this work a radiative-convective model is used to derive the temperature of an atmosphere where the optical depth is constant with respect to the frequency of radiation. The resulting temperature profile is compared with the analytical solution provided under the condition of radiative equilibrium.
\end{abstract}

% MC remove when finished.
%\tableofcontents
%\newpage

\section{Introduction}
\label{sec:Introduction}
Climate dynamics of a planet can be studied with models of varying complexity. One of the quantities analysed is the temporal and spatial distribution of temperature in the planetary atmosphere, which is the result of the heat exchange between different processes. Electromagnetic (EM) radiation is emitted, absorbed and scattered by the chemical species distributed in the atmosphere and by the planetary surface. Moreover, the atmosphere receives EM radiation by other celestial bodies, e.g. stars. Radiative processes are described by the Radiative Transfer Equation (RTE).
%\cite[25]{Modest}
Local temperature differences generate motion of fluid parcels, hence convection. A rough planetary surface can hinder horizontal heat transport. Fluid dynamics equations are needed to represent these processes.

Fluid parcels are treated as open systems and the temperature distribution is obtained by a suitable thermodynamic energy equation, coupled with the equations of the processes occuring in the atmosphere. Even by limiting the analysis to radiative processes and convection, which are the main drivers of temperature variations, the equations involved are not solvable analytically and are not tractable numerically without simplifications.

A first approximation is to consider the average over all latitudes and longitudes for quantities which depend on spatial position. The resulting atmosphere is represented by plane-parallel layers, identified by their altitude $z$ ranging from $z_\text{g}$ at ground level to $\zTOA$ at Top Of the Atmosphere (TOA). With this hypothesis, the differential equation describing the average temperature $T(t,z)$ as function of time $t$ and altitude $z$ is
\begin{equation}
  \label{eq:temperature_derivation}
  \pdv{T}{t} = -\frac{1}{\varrho c_P} \pdv{q}{z}
  \quad ,
\end{equation}
where $c_P$ is the specific heat at constant pressure of the atmosphere, $\varrho$ is the average volumetric mass density of the atmosphere and depends on atmospheric pressure $P$, $q$ is the total energy flux due to heat transfer. In general all these quantities are functions of $t$ and $z$, also through $T$. Details on the derivation are in \cite[466]{Ramanathan}, where the equation is written initially in terms of volumetric power densities and Local Thermodynamic Equilibrium (LTE) is assumed.

A second hypothesis is the radiative-convective equilibrium of the atmosphere. This translates in the existence of a steady state $\pdv*{T(t,z)}{t} = 0$ where the planet is in radiative equilibrium, i.e. the total irradiance at TOA is null, and the atmosphere is in convective equilibrium, i.e. fluid parcels are stable with respect to vertical motion.

A model with the previous assumptions is called Radiative-Convective Model (RCM).
To simplify further the RTE, in this work the dependence of quantities on the frequency of EM radiation is neglected. An atmosphere with this property is called grey atmosphere.

In the following sections the steady state vertical temperature profile of a grey atmosphere is computed. First the hypothesis of radiative equilibrium is used alone to obtain an analytical solution and use it as validation for the respective numerical solution. Then convection is taken into account and a simple RCM is implemented starting from the numerical scheme for radiative equilibrium.



\subsection{Hypotheses and conventions}
\label{sec:Hypotheses and conventions}
Some additional hypotheses are assumed to simplify the study. Data on constants are listed in table~\ref{tab:constants} and where possible, values referred to Earth are used for a prompt comparison with reality. Dependencies of quantities are written explicitly when it helps to clarify the discussion.
\begin{table*}[h]
  \centering
  \caption{Data on constants used in the present work. The middle rule separates standard values on top from arbitrary values chosen for the present work on bottom.}
  \label{tab:constants}
  \begin{tabular}[b]{cccp{0.5\textwidth}}
    \toprule
    Symbol            & Value                                                                  & Unit                                              & \centering Notes                                                                          \tabularnewline
    \midrule
    $A$               & \num{0.3}                                                              &                                                   & Bond albedo value of Earth compatible with various observations, cfr. \cite[1281]{albedo} \\
    %$A_\text{g}$      & \num{0.1}                                                              &                                                   & Average surface albedo of Earth, cfr. \cite[217]{primer}                                  \\
    $c_P$             & \num{1.004e3}                                                          & \unit{\joule\per\kelvin\per\kilogram}             & Specific heat at constant pressure of air, from \cite[16]{Catling}                        \\
    $\deltaTOA$       & \num{0}                                                                &                                                   & Optical depth at TOA, by definition                                                       \\
    $D$               & \num{1.66}                                                             &                                                   & Diffusion coefficient, commonly used value from \cite[55]{Catling}                        \\
    $g$               & \num{9.80665}                                                          & \unit{\metre\per\square\second}                   & Standard gravitational acceleration of Earth                                              \\
    $\Gamma_0$        & \num{6.5e-3}                                                           & \unit{\kelvin\per\metre}                          & Environmental lapse rate of Earth's troposphere, from \cite[3]{US1976}                    \\
    $P_\text{g}$      & \num{1.013250e5}                                                       & \unit{\pascal}                                    & Standard pressure at ground level of Earth, from \cite[2]{US1976}                         \\
    %$R$               & \num{8.31446261815324}                                                 & \unit{\joule\per\kelvin\per\mole}                 & Gas constant                                                                              \\
    $R_\text{m}$      & \num{2.8705287e2}                                                      & \unit{\joule\per\kelvin\per\kilogram}             & Specific gas constant of dry air                                                          \\
    $\sigma$          & \num{5.670374419e-8}                                                   & \unit{\watt\per\square\metre\per\kelvin\tothe{4}} & Stefan-Boltzmann constant                                                                 \\
    $S_0$             & \num{1361.0}                                                           & \unit{\watt\per\square\metre}                     & Nominal total solar irradiance, from \cite{IAU}                                           \\
    %$R_\text{sun}$    & \num{6.957e8}                                                          & \unit{\metre}                                     & Nominal solar radius, from \cite{IAU}                                                     \\
    $T_\text{g}$      & \num{288.15}                                                           & \unit{\kelvin}                                    & Earth's surface temperature based on \cite[2]{US1976}                                     \\
    %$T_\text{sun}$    & \num{5772.0}                                                           & \unit{\kelvin}                                    & Solar surface temperature, from \cite{IAU}                                                \\
    $z_\text{g}$      & \num{0}                                                                & \unit{\metre}                                     & Nominal ground level                                                                      \\
    \midrule
    $\delta_\text{g}$ & $\frac{1}{D} \Big( \frac{2 \sigma T_\text{g}^4}{S_\text{t}} - 2 \Big)$ &                                                   & Optical depth at ground level                                                             \\
    $\Delta t$        & \num{864000}                                                           & \unit{\second}                                    & Time step for temporal integration                                                        \\
    $\mu_\text{m}$    & $\frac{\delta_\text{g} g}{P_\text{g} - \PTOA}$                         & \unit{\square\metre\per\kilogram}                 & Mass attenuation coefficient of the atmosphere                                            \\
    $N$               & \num{100}                                                              &                                                   & Number of atmospheric layers                                                              \\
    $N_\text{max}$    & \num{25}                                                               &                                                   & Maximum number of atmospheric layers used for stability analysis                          \\
    %$\nu_\text{min}$  & \num{100}                                                              & \unit{\per\centi\metre}                           & Arbitrary minimum boundary for EM spectrum                                                \\
    %$\nu_\text{max}$  & \num{100000}                                                           & \unit{\per\centi\metre}                           & Arbitrary maximum boundary for EM spectrum                                                \\
    $P_0$             & \num{1e5}                                                              & \unit{\pascal}                                    & Arbitrary reference value for pressure                                                    \\
    $\PTOA$           & \num{3}                                                                & \unit{\pascal}                                    & Arbitrary TOA pressure                                                                    \\
    $S_\text{t}$      & $(1 - A) \frac{S_0}{4}$                                                & \unit{\watt\per\square\metre}                     & Irradiance transmitted from outer space to TOA                                            \\
    $T_0$             & $\big( \frac{S_\text{t}}{\sigma} \big)^\frac{1}{4}$                    & \unit{\kelvin}                                    & Arbitrary reference value for temperature                                                 \\
    $z_0$             & \num{2000}                                                             & \unit{\metre}                                     & Arbitrary constant for normalisation of altitude                                          \\
    $\zTOA$           & $z_\text{g} - z_0 \ln{\Big( \frac{P}{P_\text{g}} \Big)}$               & \unit{\metre}                                     & Arbitrary TOA altitude                                                                    \\
    \bottomrule
  \end{tabular}
\end{table*}

Some assumptions are made on the planet.
It is supposed to have a diurnal cycle, to receive a constant irradiance $S_0$ and to have a constant Bond albedo $A$. These conditions result in a costant irradiance $S_\text{t}$ transmitted to the illuminated hemisphere of the planet at TOA from outer space.
The surface of the planet is approximated as blackbody emitting in the upward direction with temperature $T_\text{g}$.
Gravitational acceleration $g$ is constant.
The atmosphere is supposed to be in hydrostatic equilibrium,
\begin{equation}
  \label{eq:hydrostatic_equilibrium}
  \odif{P} = - \varrho g \odif{z}
\end{equation}
with $P$ atmospheric pressure.
Specific heat at constant pressure $c_P$ is assumed constant.
Scattering is neglected, hence the attenutation coefficient is equal to the absorption coefficient and the symbol $\mu(z)$ is used for both.
Moreover, the absorption coefficient is supposed to depend on $z$ through
\begin{equation}
  \label{eq:absorption coefficient}
  \mu(z) = \mu_\text{m} \varrho(z)
  \quad ,
\end{equation}
where $\mu_\text{m}$ is the mass attenuation coefficient of the atmosphere, assumed constant.

For gases, specific gas constant $R_\text{m}$ is used in thermodynamic relations, which is defined as the gas constant $R$ divided by the molar mass of the gas.
They obey the ideal gas law
\begin{equation}
  \label{eq:ideal_gas_law}
  P = \varrho R_\text{m} T
  \quad .
\end{equation}

The total heat flux $q$ is determined by radiative transfer and atmospheric convection. Other means of vertical heat transfer are neglected, e.g. precipitation. The RTE is not solved directly by the RCM, instead a two-stream approximation is adopted for the radiation inside atmosphere: components of radiometric quantities in the upward and downward directions are treated separately. Neither the contribution to $q(t,z)$ due to atmospheric convection is obtained by solving the proper fluid dynamics equations, in its place a numerical correction is adopted.
% MC do a proper section for convective adjustment.
With these considerations, equation~\eqref{eq:temperature_derivation} can be rewritten as
\begin{equation}
  \label{eq:temperature}
  \pdv{T}{t} = -\frac{1}{\varrho c_P} \pdv*{\big( E_\text{U} - E_\text{D} \big)}{z}
  \quad ,
\end{equation}
where $E_\text{U}$ and $E_\text{D}$ are irradiances of upward and downward radiations, respectively.



\subsection{Vertical coordinates}
\label{sec:Vertical coordinates}
Altitude is an immediate choice as vertical coordinate used to describe the problem. However, calculations may simplify more if expressed with other coordinates.

An alternative choice is $P$ and is convenient when used with equation~\eqref{eq:hydrostatic_equilibrium} to remove the dependence on $\varrho$. A bijective relation relates $P$ and $z$ (cfr. section~\ref{sec:Relation between pressure and altitude}):
\begin{equation}
  \label{eq:pressure_altitude}
  P(z) = P_\text{g} \exp{\bigg( - \frac{z - z_\text{g}}{z_0} \bigg)}
  \quad ,
\end{equation}
where ground level is chosen as reference and constant $z_0$ acts to remove the depence on temperature and thus sets the scale of $z$. Pressure decreases with altitude from standard value $P_\text{g}$ at ground level to $\PTOA$ at TOA.

To simplify radiative calculations optical depth $\delta$ is used as vertical coordinate, starting from \num{0} at TOA and increasing downward, up to value $\delta_\text{g}$ at ground level. From the hypotheses on the attenuation coefficient, $\delta$ is a function of altitude through
\begin{equation}
  \label{eq:optical_depth_altitude}
  \delta(z) = \mu_\text{m} \int_{z}^{\zTOA} \varrho(z') \odif{z'}
  \quad ,
\end{equation}
but a simpler relation exists between $\delta$ and $P$ using equation~\eqref{eq:hydrostatic_equilibrium} to evaluate the integral in equation~\eqref{eq:optical_depth_altitude}:
\begin{equation}
  \label{eq:optical_depth_pressure}
  \delta(P) = \frac{\mu_\text{m}}{g} (P - \PTOA)
  \quad .
\end{equation}
Relation~\eqref{eq:optical_depth_pressure} is used in conjunction with equation~\eqref{eq:pressure_altitude} to derive a more direct formula for $\delta(z)$:
\begin{equation}
  \label{eq:optical_depth_altitude_2}
  \delta(z) = \frac{\mu_\text{m}}{g} \bigg( P_\text{g} \exp{\bigg( - \frac{z - z_\text{g}}{z_0} \bigg)} - \PTOA \bigg)
  \quad .
\end{equation}
Value $\PTOA$ can be calculated from a fixed $\zTOA$ using equation~\eqref{eq:pressure_altitude}, or vice versa.

Any of the previous relations for $\delta$ can be used to fix the value of $\mu_\text{m}$ if $\delta_\text{g}$ is known, or conversely $\mu_\text{m}$ can be used as parameter to derive $\delta_\text{g}$.



\section{Analytical solution in radiative equilibrium}
\label{sec:Analytical solution in radiative equilibrium}
Steady state temperature profile and irradiances considering only radiative processes are derived analytically in this section.

With the hypotheses of LTE and non-scattering medium, the RTE becomes
\begin{equation}
  \label{eq:RTE_analytical}
  \frac{1}{\mu} \pdv{L}{z} = B_\nu - L
  \quad ,
\end{equation}
where $L(t, z, \theta, \nu)$ is the spectral radiance arriving at altitude $z$ with angle $\theta$ with respect to direction $\hat{z}$ and $B_\nu(\nu, T(t,z))$ is Planck's function (cfr. section~\ref{sec:Radiometric quantities}).

To apply equation~\eqref{eq:RTE_analytical} to irradiances, two integrations are needed: one over the whole EM spectrum and one over the solid angle corresponding to a hemisphere. The latter can be performed adopting the diffusion approximation (cfr. \cite[55]{Catling}), which have the effect to substitute $\delta$ with $\delta' = D \delta$, where $D$ is the diffusion coefficient.
The resulting equations for irradiances in terms of $\delta'$ are
\begin{align}
  \label{eq:irradiance_upward}
  - \pdv*{E_\text{U}(t, \delta')}{\delta'} & = \sigma T(t, \delta')^4 - E_\text{U}(t, \delta') \quad , \\
  \label{eq:irradiance_downward}
  \pdv*{E_\text{D}(t, \delta')}{\delta'} & = \sigma T(t, \delta')^4 - E_\text{D}(t, \delta')
\end{align}
and they are coupled with equation~\eqref{eq:temperature} written in terms of $\delta'$:
\begin{equation}
  \label{eq:temperature_delta}
  \pdv*{T(t, \delta')}{t} = \frac{\mu_\text{m} D}{c_P} \pdv*{\big( E_\text{U}(t, \delta') - E_\text{D}(t, \delta') \big)}{\delta'}
  \quad .
\end{equation}
Equations~\eqref{eq:temperature_delta},~\eqref{eq:irradiance_upward} and~\eqref{eq:irradiance_downward} form a system of Partial Differential Equations (PDEs) of first order in two variables.

When the steady state of $T$ is searched, dependence on $t$ is dropped and the PDEs become Ordinary Differential Equations (ODEs) of first order of an Initial Value Problem (IVP).
Initial conditions for irradiances are
\begin{equation}
  \label{eq:initial_downward}
  E_\text{D}(0) = 0
\end{equation}
because energy released to atmosphere at TOA by the downward flux is negligible and $E_\text{U}(0)$ is a constant called Outgoing Longwave Radiation (OLR).
Radiative equilibrium provides the condition for the OLR:
\begin{equation}
  \label{eq:initial_upward}
  E_\text{U}(0) = S_\text{t}
  \quad .
\end{equation}
Moreover, at the steady state irradiances are related by
\begin{equation}
  \label{eq:irradiance_steady_state}
  \odv*{\big( E_\text{U}(\delta') - E_\text{D}(\delta') \big)}{\delta'} = 0
  \quad ,
\end{equation}
which has constant solution determined by the condition of radiative equilibrium for the planet:
\begin{equation}
  \label{eq:irradiance_steady_state_solution}
  E_\text{U}(\delta') - E_\text{D}(\delta') = S_\text{t}
  \quad .
\end{equation}
Same relations are derived if the hypotheses of atmosphere in radiative equilibrium at all altitudes and atmopshere transparent to radiation coming from outside the planet are considered instead of atmopshere in radiative equilibrium at TOA and steady state.

An ODE for $T$ can be written by adding and subtracting equations~\eqref{eq:irradiance_upward} and~\eqref{eq:irradiance_downward} and using relations~\eqref{eq:irradiance_steady_state} and~\eqref{eq:irradiance_steady_state_solution}:
\begin{equation}
  \label{eq:temperature_analytical}
  2 \sigma \odv*{T(\delta')^4}{\delta'} = S_\text{t}
  \quad .
\end{equation}
In a similar way, initial condition for $T$ is obtained by summing equations~\eqref{eq:irradiance_upward} and~\eqref{eq:irradiance_downward} and applying relation~\eqref{eq:irradiance_steady_state} and the initial conditions~\eqref{eq:initial_upward} and~\eqref{eq:initial_downward}:
\begin{equation}
  \label{eq:initial_temperature}
  T(0) = \bigg( \frac{S_\text{t}}{2 \sigma} \bigg)^\frac{1}{4}
  \quad .
\end{equation}
The solution of equation~\eqref{eq:temperature_analytical} in terms of $\delta$ is
\begin{equation}
  \label{eq:temperature_analytical_solution}
  T(\delta) = \bigg( \frac{S_\text{t}}{2 \sigma} (1 + D \delta) \bigg)^\frac{1}{4}
  \quad ,
\end{equation}
represented in figure~\ref{fig:temperature}.
\begin{figure*}[h]
  \centering
  \includegraphics*[keepaspectratio=true,width=0.75\textwidth]{temperature}
  \caption{Vertical temperature profile of a grey atmosphere. Continuous line is analytical solution in radiative equilibrium, dashed line is numerical solution in radiative-convective equilibrium. Correction to temperature with lapse rate greater than the critical value is visible at lower altitudes. A discontinuity is present at ground level due to the lack of heat exchange between surface and the lowest atmospheric layer.}
  \label{fig:temperature}
\end{figure*}

Once the temperature profile is known, $E_\text{U}(\delta)$ and $E_\text{D}(\delta)$ are evaluated with the same procedure used previously for $T(\delta')$, resulting in:
\begin{align}
  \label{eq:irradiance_upward_solution}
  E_\text{U}(\delta) & = \frac{S_\text{t}}{2} (2 + D \delta) \quad , \\
  \label{eq:irradiance_downward_solution}
  E_\text{D}(\delta) & = \frac{S_\text{t}}{2} D \delta
  \quad .
\end{align}
Irradiances are shown in figure~\ref{fig:irradiance}. At every altitude, $E_\text{U}$ and $E_\text{D}$ are greater then their respective values at TOA. This is result of the greenhouse effect of the atmosphere.
\begin{figure*}[h]
  \centering
  \includegraphics*[keepaspectratio=true,width=0.75\textwidth]{irradiance}
  \caption{Upward and downward irradiances in a grey atmosphere. Continuous line is the solution in radiative equilibrium, dashed line is solution in radiative-convective equilibrium. Greater values than TOA at lower altitudes are indicators of greenhouse effect. Irradiances of the RCM are not directly subject of convective adjustment, but they are affected due to the dependence on temperature.}
  \label{fig:irradiance}
\end{figure*}

Value $\delta_\text{g}$ can be fixed by using the irradiance emitted by the surface of the planet:
\begin{equation}
  \label{eq:irradiance_upward_ground}
  E_\text{U}(\delta_\text{g}) = \sigma T_\text{g}^4
  \quad .
\end{equation}
With this condition, $T$ presents a discontinuity at ground level, which is not physical. Other mechanisms of heat transport redistribute energy between the surface and the atmospheric layer directly above, removing the discontinuity. Their effect can be simulated by imposing radiative equilibrium at ground level.



\section{Numerical solution in radiative equilibrium}
\label{sec:Numerical solution in radiative equilibrium}
To solve numerically the IVP defined in section~\ref{sec:Analytical solution in radiative equilibrium}, equations~\eqref{eq:temperature_analytical},~\eqref{eq:irradiance_upward} and~\eqref{eq:irradiance_downward} are rewritten in terms of variable $\delta$ and normalised,
\begin{equation}
  \label{eq:normalisation}
  Y_0 = \frac{T^4}{T_0^4}
  \quad , \quad
  Y_1 = \frac{E_\text{U}}{S_\text{t}}
  \quad , \quad
  Y_2 = \frac{E_\text{U}}{S_\text{t}}
\end{equation}
with $T_0$ chosen arbitrarily, resulting in the system of ODEs
\begin{equation}
  \label{eq:numerical_steady_state}
  \left\{
  \begin{array}{@{}l@{}}
    \odv{Y_0}{\delta} = \frac{D}{2} \\[0.5em]
    \odv{Y_1}{\delta} = D (Y_1 - Y_0) \\[0.5em]
    \odv{Y_2}{\delta} = D (Y_0 - Y_2)
  \end{array}
  \right.
  \quad .
\end{equation}
Initial conditions for the normalised functions are
\begin{equation}
  \label{eq:initial_normalisation}
  Y_0 = \frac{1}{2}
  \quad , \quad
  Y_1 = 1
  \quad , \quad
  Y_2 = 0
  \quad ,
\end{equation}
from conditions~\eqref{eq:initial_temperature},~\eqref{eq:initial_upward} and~\eqref{eq:initial_downward}, respectively.

Runge-Kutta method of order 4 is used to integrate system~\eqref{eq:numerical_steady_state}, to maintain accuracy when $T$ is derived from $Y_0$. Non-uniform step sizes are adopted, because values $\delta$ are obtained from uniformly distributed values $z$ through relation~\eqref{eq:optical_depth_altitude_2}.

Accuracy of the numerical procedure is quantified through the errors of normalised temperature and irradiances with respect to analytical solutions. Errors are compatible with 0 based on precision of double-precision floating-point numbers, as shown in figure~\ref{fig:errors}.
\begin{figure*}[h]
  \centering
  \includegraphics*[keepaspectratio=true,width=0.75\textwidth]{errors}
  \caption{Errors between numerical and analytical solutions of a grey atmosphere in radiative equilibrium. Points at some altitudes are not shown because their value is exactly 0.}
  \label{fig:errors}
\end{figure*}

\subsection{Stability analysis}
Stability of the numerical method with respect to spatial grid size is studied varying $N$. Powers of 2 in the interval $[1, N_\text{max}]$ are chosen as values of $N$ and step size is kept constant, obtained by dividing interval $[\deltaTOA, \delta_\text{g}]$ in $N$ subintervals. Errors are evaluated as absolute differences between numerical and analytical values for each of $T(\delta_\text{g})$, $E_\text{U}(\delta_\text{g})$ and $E_\text{U}(\delta_\text{g})$.

In figure~\ref{fig:stability} errors are plotted as function of $N$. For $N \leq 4096$, they are compatible with 0 within precision, while for greater $N$, they increase due to error propagation. In general, this behaviour does not hinder results of simulations because lower values of $N$ are chosen for the model, otherwise averages approximating dynamics could lose accuracy and the computational demand of the equations involved could increase considerably.
\begin{figure*}[h]
  \centering
  \includegraphics*[keepaspectratio=true,width=0.75\textwidth]{stability}
  \caption{Stability of numerical solution in radiative equilibrium with respect to spatial grid size. Missing points have value 0.}
  \label{fig:stability}
\end{figure*}



\subsection{Time integration}
\label{sec:Time integration}
Numerical solutions for system~\eqref{eq:numerical_steady_state} are obtained by using in advance the steady state condition~\eqref{eq:irradiance_steady_state}. To preserve information on temporal depence, the more general system given by PDEs~\eqref{eq:temperature_delta},~\eqref{eq:irradiance_upward} and~\eqref{eq:irradiance_downward} is solved numerically.
More precisely, each variable is considered separately during the integration and an iterative procedure is adopted: starting from an arbitrary temperature profile, equations~\eqref{eq:irradiance_upward} and~\eqref{eq:irradiance_downward} are solved with respect to $\delta'$, then the resulting $E_\text{U}$ and $E_\text{D}$ are used to step forward $T$ with respect to $t$ using equation~\eqref{eq:temperature_delta} for each layer, obtaining a new temperature profile to restart the loop. The iterations continue until a steady state for $T$ is reached. This procedure describes an IVP with respect to $\delta'$ for $T$, $E_\text{U}$ and $E_\text{D}$ and an IVP with respect to $t$ for $T$.

Normalisations~\eqref{eq:normalisation} and
\begin{equation}
  \label{eq:temperature_normalisation}
  Y_3 = \frac{T}{T_0}
\end{equation}
are used and $\delta$ is chosen as coordinate, hence the system of PDEs is rewritten as
\begin{equation}
  \label{eq:numerical_radiative_equilibrium}
  \left\{
  \begin{array}{@{}l@{}}
    \pdv*{Y_3(t, \delta)}{t} = \frac{\mu_\text{m} S_\text{t}}{c_P T_0} \pdv*{(Y_1(t, \delta) - Y_2(t, \delta))}{\delta} \\[0.5em]
    \pdv*{Y_1(t, \delta)}{\delta} = D (Y_1(t, \delta) - Y_3(t, \delta)^4) \\[0.5em]
    \pdv*{Y_2(t, \delta)}{\delta} = D (Y_3(t, \delta)^4 - Y_2(t, \delta))
  \end{array}
  \right.
  \quad .
\end{equation}
At the start of the procedure, the initial condition for $T$ is an arbitrary temperature profile, while at each temporal step, initial conditions~\eqref{eq:initial_normalisation} are reapplied. Point $Y_3(0, 0) = \frac{1}{2}$ is fixed by relation but it is not used during the integration.

Integration of irradiances is performed as before using Runge-Kutta method of order 4. For the temporal integration of $T$ Euler method is used with a costant time step $\Delta t$, chosen arbitrarily to reduce the errors of irradiances below the precision of numeric values outputs.

Figure~\ref{fig:errors_PDE} displays errors between numerical solutions of PDE system~\eqref{eq:numerical_radiative_equilibrium} and analytical solutions. Errors are propagated during the iterations, limiting the precision of the numerical procedure.
\begin{figure*}[h]
  \centering
  \includegraphics*[keepaspectratio=true,width=0.75\textwidth]{errors_PDE}
  \caption{Errors between numerical and analytical solutions of a grey atmosphere in radiative equilibrium. Steady state is reached throught iterative temporal and spatial integration. Precision is reduced by propagation of errors during successive iterations. Points at TOA are omitted being compatible with 0 within precision of double-precision floating-point numbers.}
  \label{fig:errors_PDE}
\end{figure*}



\newpage
\appendix

\onecolumn
\section{Source code}
In this section the code written in \cpp\ used to obtain the results presented in this work is shown.
\lstinputlisting[language=C++,style=mystyle]{../code/main.cpp}



\twocolumn
\section{Mathematical derivations}
In this appendix mathematical derivations of some ancillary results and formulae used in the main text are explicitly shown.



\subsection{Relation between pressure and altitude}
\label{sec:Relation between pressure and altitude}
A general result regarding planetary atmospheres is that atmospheric pressure decreases with increasing altitude. Theoretical relations which approximate this behaviour can be obtained. Hypotheses considered in section~\ref{sec:Introduction} are valid.

If density is assumed constant, equation~\eqref{eq:hydrostatic_equilibrium} can be solved easily resulting in a linear dependence of pressure $P$ on altitude $z$,
\begin{equation}
  \label{eq:pressure_constant_density}
  P(z) = P_0 - \varrho g (z - z_0)
  \quad ,
\end{equation}
where $(z_0, P_0)$ is a reference point inside the atmosphere.

If density is not constant its expression is given by the ideal gas law (cfr. equation~\eqref{eq:ideal_gas_law}) and, assuming constant temperature $T$, equation~\eqref{eq:hydrostatic_equilibrium} becomes
\begin{equation}
  \label{eq:hydrostatic_equilibrium_ideal_gas_law_constant_temperature}
  \begin{split}
    & \odif{P} = - \frac{P g}{R_\text{m} T} \odif{z} \iff \\
    \iff & \frac{\odif{P}}{P} = - \frac{g}{R_\text{m} T} \odif{z}
  \end{split}
\end{equation}
with solution
\begin{equation}
  \label{eq:pressure_constant_temperature}
  \begin{split}
    & \ln(P') \bigg|_{P_0}^{P(z)} = - \frac{g}{R_\text{m} T} z' \bigg|_{z_0}^{z} \iff \\
    \iff & P(z) = P_0 \exp{\bigg( - \frac{g}{R_\text{m} T} (z - z_0) \bigg)}
    \quad .
  \end{split}
\end{equation}
This relation is not meaningful, since the aim of the work is to derive the non-constant temperature profile of the atmosphere. However, it can be used inside atmospheric layers where the temperature is considered constant (e.g. stratosphere).

A better approximation assumes non-constant density and constant lapse rate $\Gamma$, hence temperature depends linearly on altitude,
\begin{equation}
  \label{eq:constant_lapse_rate}
  \Gamma = - \frac{\odif{T}}{\odif{z}} \impliedby T(z) = T_0 - \Gamma (z - z_0)
  \quad ,
\end{equation}
with $T_0$ temperature corresponding to reference altitude $z_0$. Using these assumptions and the density rewritten through the ideal gas law \eqref{eq:ideal_gas_law}, equation~\eqref{eq:hydrostatic_equilibrium} becomes
\begin{equation}
  \label{eq:hydrostatic_equilibrium_ideal_gas_law_constant_lapse_rate}
  \begin{split}
    & \odif{P} = - \frac{P g}{R_\text{m} T} \bigg( - \frac{\odif{T}}{\Gamma} \bigg) \iff \\
    \iff & \frac{\odif{P}}{P} = \frac{g}{R_\text{m} \Gamma} \frac{\odif{T}}{T}
    \quad ,
  \end{split}
\end{equation}
which has solution
\begin{equation}
  \label{eq:pressure_constant_lapse_rate}
  \begin{split}
    & \ln(P') \bigg|_{P_0}^{P(z)} = \frac{g}{R_\text{m} \Gamma} \ln(T') \bigg|_{T_0}^{T(z)} \iff \\
    \iff & P(z) = P_0 \bigg( \frac{T_0 - \Gamma (z - z_0)}{T_0} \bigg)^\frac{g}{R_\text{m} \Gamma}
    \quad .
  \end{split}
\end{equation}

Equation \eqref{eq:pressure_constant_lapse_rate} can be used also with a piecewise constant lapse rate in altitude intervals where it is not null. Otherwise, in altitude intervals where lapse rate is null, equation \eqref{eq:pressure_constant_temperature} is valid with appropriate boundary conditions to ensure continuity between layers.



\subsection{Radiometric quantities}
\label{sec:Radiometric quantities}
Refer to \cite{CIE} for more details on quantities reviewed in this section.

Consider electromagnetic radiation emitted by a point source. The total emitted power is called \emph{radiant flux}, with unit \unit{\watt}. The density of radiant flux with respect to a solid angle in the direction of emission is called \emph{radiant intensity}, expressed in \unit{\watt\per\steradian}. When radiation interacts with a surface, i.e. it gets absorbed, transmitted or reflected, its radiant intensity distributed over the surface is measured through \emph{radiance} in \unit{\watt\per\square\metre\per\steradian}. If the area on which the radiation is incident is expressed through the solid angle it subtends, the integral of radiance over this solid angle is called \emph{irradiance}, expressed in \unit{\watt\per\square\metre}. Note that the coordinate system where the solid angles of radiant intensity and irradiance are defined may not be the same. Radiant flux emitted by a body normalised over the surface of emission is measured by \emph{radiant exitance} in \unit{\watt\per\square\metre}.

% MC if needed make a consideration for the case where there is no source and only the radiation incident on a surface is considered. This phenomenon is addressed as diffusion.

All previous quantities can be expressed as densities with respect to the wavelength or the wavenumber and the adjective \emph{spectral} is prefixed to their names. Their units are divided by the respective spectral quantity (e.g. spectral radiance with wavenumber in \unit{\per\centi\metre} has units \unit{\watt\per\metre\squared\centi\metre\per\steradian}).

Spectral radiance of a blackbody is given by Planck's law
\begin{equation}
  \label{eq:spectral_radiance_blackbody}
  B_\nu (\nu, T) = 2 h c^2 \nu^3 \frac{1}{e^\frac{h c \nu}{k_B T} - 1}
  \quad ,
\end{equation}
where $\nu$ is the wavenumber in unit \unit{\per\centi\metre}, $T$ in unit \unit{\kelvin} is the temperature of the emitting body and the other quantities are constants (cfr. table~\ref{tab:constants}).
Note that Planck's law has different form when it is expressed in terms of wavelength, due to its definition as density and the resulting change of variables:
\begin{equation}
  \label{eq:spectral_radiance_blackbody_lambda}
  B_\lambda (\lambda, T) = \frac{2 h c^2}{\lambda^5} \frac{1}{e^\frac{h c}{\lambda k_B T} - 1}
  \quad .
\end{equation}

If radiance is isotropic, i.e. it is not dependent on the direction of the radiation, the corresponding irradiance is proportional. For instance, if the radiation is absorbed by a hemispheric surface approximated by a blackbody, the spectral irradiance of the surface is
\begin{equation}
  \label{eq:spectral_irradiance_blackbody_hemisphere}
  \begin{split}
    & \int B_\nu (\nu, T) \odif{\phi} \sin(\theta) \odif{\theta} \cos(\theta) = \\
    & = B_\nu (\nu, T) \int_0^{2\pi} \odif{\phi} \int_0^\frac{\pi}{2} \sin(\theta) \cos(\theta) \odif{\theta} = \\
    & = 2 \pi B_\nu (\nu, T) \int_0^1 \sin(\theta) \odif{(\sin(\theta))} = \\
    & = 2 \pi B_\nu (\nu, T) \frac{1}{2} = \\
    & = \pi B_\nu (\nu, T)
    \quad ,
  \end{split}
\end{equation}
where spherical coordinates are used to describe the surface and the term $\cos(\theta)$ considers the component of radiation along the normal of the infinitesimal solid angle.



\subsection{Radiation attenuation}
\label{sec:Radiation attenuation}
Details on quantities appearing in this section can be found in \cite[285]{Modest}.
Radiation crossing a medium loses energy due to absorption and scattering. The effect of chemical species on these processes is quantified through the \emph{attenuation coefficient} (commonly called \emph{extinction coefficient} in atmospheric sciences), which has different definitions based on the way it is derived (cfr. \cite[44]{Catling}). The attenuation coefficient is the sum of \emph{absorption coefficient} and \emph{scattering coefficient} which contain information on the attenuation due to the respective physical processes. The \emph{optical depth} (also called \emph{optical thickness}) takes in consideration the amount of substance involved in the absorption.

Ratios between radiant fluxes are related by the conservation of energy: the sum of \emph{internal transmittance} and \emph{internal absorptance} is 1, as well as the sum of \emph{reflectance}, \emph{absorptance} and \emph{transmittance}.

In general these coefficients are functions of wavelength or wavenumber, in which case the prefix \emph{spectral} is adopted. If the medium is a fluid, they depends on temperature and pressure of the medium.
Another related quantity is the spectral internal transmittance
\begin{equation}
  \label{eq:spectral_internal_transmittance}
  \tau_\text{i}(\nu, s, s_0) = e^{-\delta(\nu, s, s_0)}
  \quad ,
\end{equation}
where $\delta(\nu, s, s_0)$ is the spectral optical depth, which depends only on the spectral attenuation coefficient $\mu(\nu, s')$ of the medium traversed by the radiation from $s_0$ to $s$ on the optical path. In the RCM optical paths are straight and form an angle $\theta$ with the direction normal to the layers, hence the definition of the spectral optical depth becomes:
\begin{equation}
  \label{eq:spectral_optical_depth}
  \delta(\nu, s, s_0) = \frac{1}{\cos \theta} \int_{s_0}^{s} \mu(\nu, s') \odif{s'}
  \quad .
\end{equation}
If the absorbing species do not interact, $\mu(\nu, s')$ is simply the sum of the spectral attenuation coefficients of the individual components of the medium.

Moreover, if the medium is homogenoeus, in the sense that quantities affecting radiative calculations are not dependent on spatial position (e.g. attenuation coefficients $\mu$ are constant inside the medium), the spectral attenuation coefficient depends only on the concentration of the absorbing species contained, hence the spectral attenuation coefficient can be rewritten as
\begin{equation}
  \label{eq:spectral_attenuation_coefficient}
  \mu(\nu, s') = \mu_\text{m}(\nu) \rho(s')
\end{equation}
where $\mu_\text{m}(\nu)$ is the spectral mass attenuation coefficient and $\rho(s')$ is the volumetric mass density of the absorber.

Names of radiative properties ending with suffix \emph{-ance} are generally used for rough surfaces, while suffix \emph{-ivity} indicates smooth surfaces. In this work the former is adopted. Refer to \cite[59]{Modest} for more information and to the definition of spectral absorptivity in \cite{CIE} for an example of the difference.



\subsection{Quantities commonly used in atmospheric sciences}
\label{sec:Quantities commonly used in atmospheric sciences}
Earth's surface horizontal profile is not uniform, hence altitude and pressure near ground level could present sudden variations. In models where this is taken into consideration, the sigma coordinate system is commonly used instead, defined by
\begin{equation}
  \label{eq:sigma_coordinate}
  \sigma = \frac{P - \PTOA}{P_\text{g} - \PTOA}
  \quad .
\end{equation}
To avoid confusion, in this work symbol $\sigma$ is used for the Stefan-Boltzmann constant (cfr. table~\ref{tab:constants}), except for equation~\eqref{eq:sigma_coordinate}.

An alternative quantity evaluated in place of $T(t,z)$ for a given parcel of fluid is the potential temperature
\begin{equation}
  \label{eq:potential_temperature}
  \theta(t,z) = T(t,z) \bigg( \frac{P_0}{P(z)} \bigg)^\frac{R_\text{m}}{c_P}
  \quad ,
\end{equation}
where $P_0$ is a reference pressure and quantities $P(z)$, $R_\text{m}$ and $c_P$ refer to the fluid.



\section{Supplementary information}



\subsection{Plotting}
\label{sec:Plotting}
Software gnuplot is used to generate plots shown in this work. Output values from the simulation are stored in a DAT file.



\newpage
\printbibliography[heading=bibintoc]
\end{document}
